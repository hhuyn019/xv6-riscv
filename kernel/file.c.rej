--- kernel/file.c
+++ kernel/file.c
@@ -16,7 +16,7 @@
 struct devsw devsw[NDEV];
 struct {
   struct spinlock lock;
-  struct file file[NFILE];
+//  struct file file[NFILE];
 } ftable;
 
 void
@@ -32,13 +32,15 @@
   struct file *f;
 
   acquire(&ftable.lock);
-  for(f = ftable.file; f < ftable.file + NFILE; f++){
-    if(f->ref == 0){
-      f->ref = 1;
-      release(&ftable.lock);
-      return f;
-    }
-  }
+	
+	f = bd_malloc(sizeof(struct file));
+	if(f > 0) {
+		memset(f,0,sizeof(struct file));
+		f->ref = 1;
+		release(&ftable.lock);
+		return f;
+	}
+
   release(&ftable.lock);
   return 0;
 }
@@ -80,6 +82,7 @@
     iput(ff.ip);
     end_op(ff.ip->dev);
   }
+	bd_free(f);
 }
 
 // Get metadata about file f.
